<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Party Sync (Online)</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #121212; color: #e0e0e0; padding: 20px; margin: 0; }
        
        /* Status Bar */
        #status-indicator {
            position: fixed; top: 10px; right: 10px; padding: 5px 10px; border-radius: 20px; font-size: 0.8em; font-weight: bold; z-index: 1000;
        }
        .status-online { background: #28a745; color: white; box-shadow: 0 0 10px #28a745; }
        .status-offline { background: #dc3545; color: white; }

        /* Layout Grid */
        .main-layout { display: flex; gap: 20px; align-items: flex-start; margin-top: 20px; }
        .sidebar { flex: 0 0 300px; background: #1e1e1e; padding: 15px; border-radius: 8px; border: 1px solid #333; position: sticky; top: 20px; max-height: 90vh; overflow-y: auto; }
        .content-area { flex: 1; display: flex; flex-direction: column; gap: 20px; }

        h2, h3 { margin-top: 0; color: #ffcc00; }
        input, select { background: #333; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
        input:focus { outline: 2px solid #ffcc00; }

        /* Buttons */
        button { cursor: pointer; border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .btn-green { background: #28a745; color: white; }
        .btn-blue { background: #007bff; color: white; }
        .btn-red { background: #dc3545; color: white; }
        .btn-move { background: #444; color: white; padding: 2px 8px; }

        /* Skill Preset Item */
        .preset-item { background: #2a2a2a; padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #007bff; display: flex; justify-content: space-between; align-items: center; }

        /* Character Card */
        .char-card { background: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: 0.3s; }
        .char-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; }
        .char-name { font-size: 1.3em; font-weight: bold; background: transparent; border: none; color: #ffcc00; width: 60%; }
        
        .skill-row { display: flex; align-items: center; gap: 10px; background: #252525; padding: 8px; margin-bottom: 4px; border-radius: 4px; border-left: 3px solid #ffcc00; }
        
        .result-area { text-align: right; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #444; }
        .big-number { font-size: 2.5em; font-weight: bold; color: #00ff00; text-shadow: 0 0 10px rgba(0,255,0,0.2); }
    </style>
</head>
<body>

    <div id="status-indicator" class="status-offline">Connecting...</div>

    <div class="main-layout">
        
        <div class="sidebar">
            <h2>üõ†Ô∏è ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏Å‡∏¥‡∏•‡∏Å‡∏•‡∏≤‡∏á</h2>
            <div style="background: #252525; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                <input type="text" id="newSkillName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏¥‡∏• (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏±‡∏û‡πÄ‡∏ó‡∏û)" style="width: 90%; margin-bottom: 5px;">
                <div style="display: flex; gap: 5px;">
                    <select id="newSkillOp">
                        <option value="*">‡∏Ñ‡∏π‡∏ì (*)</option>
                        <option value="+">‡∏ö‡∏ß‡∏Å (+)</option>
                        <option value="-">‡∏•‡∏ö (-)</option>
                        <option value="/">‡∏´‡∏≤‡∏£ (/)</option>
                    </select>
                    <input type="number" id="newSkillVal" placeholder="‡∏Ñ‡πà‡∏≤" style="width: 100%;">
                </div>
                <button class="btn-green" onclick="window.savePreset()" style="width: 100%; margin-top: 5px;">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏Å‡∏¥‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á</button>
            </div>
    
            <div id="presetList">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <div style="font-size: 0.8em; color: #888; margin-top: 20px;">
                * ‡∏™‡∏Å‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
            </div>
        </div>
    
        <div class="content-area">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin:0;">‚öîÔ∏è Party Damage (Online)</h1>
                    <small style="color:#aaa;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏ö‡∏ö Real-time</small>
                </div>
                <button class="btn-blue" style="font-size: 1.1em; padding: 10px 20px;" onclick="window.addCharacter()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
            </div>
    
            <div id="charactersContainer">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>
    
    </div>

<script type="module">
    // Import SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBEw0zATJP-H1fFR6Lp979Q_z1xSV2q2ys",
        authDomain: "jtg-01t.firebaseapp.com",
        databaseURL: "https://jtg-01t-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "jtg-01t",
        storageBucket: "jtg-01t.firebasestorage.app",
        messagingSenderId: "45439731374",
        appId: "1:45439731374:web:93f808e462d1a791974f3f",
        measurementId: "G-PN807S1Y1H"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global Variables (State)
    let presets = [];
    let characters = [];

    // --- 1. Real-time Listener (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏´‡∏•‡∏±‡∏Å) ---
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Database ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô -> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    const dbRef = ref(db, 'gameData');
    
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        
        // Update Status
        const statusEl = document.getElementById('status-indicator');
        statusEl.className = 'status-online';
        statusEl.innerText = 'üü¢ Online Sync';

        if (data) {
            presets = data.presets || [];
            characters = data.characters || [];
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            presets = [];
            characters = [];
        }
        
        renderPresets();
        renderAllChars();
    }, (error) => {
        console.error(error);
        const statusEl = document.getElementById('status-indicator');
        statusEl.className = 'status-offline';
        statusEl.innerText = 'üî¥ Disconnected (Check Rules)';
    });

    // --- 2. Action Functions (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô Cloud) ---
    // ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏ß‡∏Å‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤ window ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô module
    
    window.savePreset = () => {
        const name = document.getElementById('newSkillName').value;
        const op = document.getElementById('newSkillOp').value;
        const val = parseFloat(document.getElementById('newSkillVal').value);

        if (!name || isNaN(val)) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Local ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß) ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏£‡∏≠‡πÄ‡∏•‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ
        const newPresets = [...presets, { id: Date.now(), name, op, val }];
        set(ref(db, 'gameData/presets'), newPresets);
        
        // Clear Inputs
        document.getElementById('newSkillName').value = '';
    }

    window.deletePreset = (index) => {
        if(!confirm("‡∏•‡∏ö‡∏™‡∏Å‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á?")) return;
        const newPresets = [...presets];
        newPresets.splice(index, 1);
        set(ref(db, 'gameData/presets'), newPresets);
    }

    window.addCharacter = () => {
        const newChars = [...characters, {
            id: Date.now(),
            name: "‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà",
            baseDmg: 0,
            stack: []
        }];
        set(ref(db, 'gameData/characters'), newChars);
    }

    window.removeCharacter = (id) => {
        if(!confirm("‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ?")) return;
        const newChars = characters.filter(c => c.id !== id);
        set(ref(db, 'gameData/characters'), newChars);
    }

    window.updateCharName = (id, newName) => {
        // ‡∏´‡∏≤ Index ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏Å‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡πâ‡∏ô
        const index = characters.findIndex(c => c.id === id);
        if (index !== -1) {
            // ‡∏™‡πà‡∏á update ‡πÑ‡∏õ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ path ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏±‡πâ‡∏ô (‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞‡πÄ‡∏ô‡πá‡∏ï)
            set(ref(db, `gameData/characters/${index}/name`), newName);
        }
    }

    window.updateBaseDmg = (id, newVal) => {
        const index = characters.findIndex(c => c.id === id);
        if (index !== -1) {
            set(ref(db, `gameData/characters/${index}/baseDmg`), parseFloat(newVal));
        }
    }

    window.addSkillToChar = (charId) => {
        const selectBox = document.getElementById(`select-skill-${charId}`);
        const presetIndex = selectBox.value;
        if (presetIndex === "") return;

        const charIndex = characters.findIndex(c => c.id === charId);
        if (charIndex === -1) return;

        const skill = presets[presetIndex];
        const currentStack = characters[charIndex].stack || [];
        const newStack = [...currentStack, { ...skill, uid: Date.now() }];

        set(ref(db, `gameData/characters/${charIndex}/stack`), newStack);
    }

    window.removeSkillFromChar = (charId, skillIndex) => {
        const charIndex = characters.findIndex(c => c.id === charId);
        const stack = characters[charIndex].stack || [];
        stack.splice(skillIndex, 1);
        set(ref(db, `gameData/characters/${charIndex}/stack`), stack);
    }

    window.moveSkillOrder = (charId, skillIndex, direction) => {
        const charIndex = characters.findIndex(c => c.id === charId);
        const stack = [...(characters[charIndex].stack || [])];
        
        if (skillIndex + direction >= 0 && skillIndex + direction < stack.length) {
            const temp = stack[skillIndex];
            stack[skillIndex] = stack[skillIndex + direction];
            stack[skillIndex + direction] = temp;
            set(ref(db, `gameData/characters/${charIndex}/stack`), stack);
        }
    }


    // --- 3. Rendering Logic (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•) ---
    function renderPresets() {
        const list = document.getElementById('presetList');
        list.innerHTML = '';
        if(!presets.length) { list.innerHTML = '<div style="color:#555; text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡∏Å‡∏•‡∏≤‡∏á</div>'; return; }

        presets.forEach((p, i) => {
            let symbol = p.op === '*' ? 'x' : p.op;
            list.innerHTML += `
                <div class="preset-item">
                    <span>${p.name} <span style="color:#aaa;">(${symbol}${p.val})</span></span>
                    <button class="btn-red" style="padding: 2px 6px; font-size:0.8em;" onclick="window.deletePreset(${i})">X</button>
                </div>
            `;
        });
    }

    function calculateChar(char) {
        let current = char.baseDmg || 0;
        let stack = char.stack || [];
        
        stack.forEach(s => {
            if (s.op === '+') current += s.val;
            if (s.op === '-') current -= s.val;
            if (s.op === '*') current *= s.val;
            if (s.op === '/') current /= s.val;
        });
        return Math.floor(current);
    }

    function renderAllChars() {
        const container = document.getElementById('charactersContainer');
        
        // ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á element ‡∏ó‡∏µ‡πà active ‡∏≠‡∏¢‡∏π‡πà (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ focus ‡∏´‡∏•‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå)
        const activeElementId = document.activeElement ? document.activeElement.id : null;
        
        container.innerHTML = '';

        if(!characters.length) {
            container.innerHTML = '<div style="color:#555; text-align:center; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏ô‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ</div>';
            return;
        }

        characters.forEach((char, index) => {
            const finalDmg = calculateChar(char);
            
            // Build Options
            let options = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏Å‡∏¥‡∏• --</option>`;
            presets.forEach((p, idx) => {
                let symbol = p.op === '*' ? 'x' : p.op;
                options += `<option value="${idx}">${p.name} (${symbol}${p.val})</option>`;
            });

            // Build Stack
            let stackHtml = '';
            const stack = char.stack || [];
            if (stack.length === 0) {
                stackHtml = `<div style="text-align:center; color:#555; padding:10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏û/‡∏î‡∏µ‡∏ö‡∏±‡∏û</div>`;
            } else {
                stack.forEach((s, idx) => {
                    let symbol = s.op === '*' ? 'x' : s.op;
                    stackHtml += `
                        <div class="skill-row">
                            <span style="font-weight:bold; color:#ffcc00; width:20px;">${idx+1}.</span>
                            <div style="flex:1;">
                                <div>${s.name}</div>
                                <div style="font-size:0.8em; color:#aaa;">${symbol} ${s.val}</div>
                            </div>
                            <div>
                                <button class="btn-move" onclick="window.moveSkillOrder(${char.id}, ${idx}, -1)">‚ñ≤</button>
                                <button class="btn-move" onclick="window.moveSkillOrder(${char.id}, ${idx}, 1)">‚ñº</button>
                                <button class="btn-red" style="padding:2px 6px;" onclick="window.removeSkillFromChar(${char.id}, ${idx})">X</button>
                            </div>
                        </div>
                    `;
                });
            }

            // Create HTML
            // Note: ‡πÉ‡∏™‡πà ID ‡πÉ‡∏´‡πâ input ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Restore focus ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å
            const html = `
                <div class="char-card" id="card-${char.id}">
                    <div class="char-header">
                        <input type="text" id="name-${char.id}" class="char-name" value="${char.name}" 
                               onchange="window.updateCharName(${char.id}, this.value)">
                        <button class="btn-red" onclick="window.removeCharacter(${char.id})">‡∏•‡∏ö</button>
                    </div>

                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1;">
                            <label style="font-size:0.8em; color:#aaa;">Base Dmg</label>
                            <input type="number" id="base-${char.id}" value="${char.baseDmg || ''}" placeholder="0" 
                                   style="width:100%; font-size:1.2em;" 
                                   onchange="window.updateBaseDmg(${char.id}, this.value)">
                        </div>
                        <div style="flex:2; display:flex; align-items:flex-end; gap:5px;">
                            <select id="select-skill-${char.id}" style="flex:1;">${options}</select>
                            <button class="btn-green" onclick="window.addSkillToChar(${char.id})">‡πÇ‡∏õ‡∏∞!</button>
                        </div>
                    </div>

                    <div style="background:#1a1a1a; padding:5px; border-radius:4px; min-height:50px;">
                        ${stackHtml}
                    </div>

                    <div class="result-area">
                        <span style="color:#aaa;">Damage ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                        <div class="big-number">${finalDmg.toLocaleString()}</div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });

        // Restore Focus (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏•‡∏∏‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Re-render)
        if(activeElementId) {
            const el = document.getElementById(activeElementId);
            if(el) el.focus();
        }
    }

</script>

</body>
</html>